name: CI/CD Pipeline

on:
    pull_request:
        branches: [main]
        types: [opened, synchronize, reopened]
    push:
        branches: [main]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    # ✅ Runs only on PR (no deployment)
    build-pr:
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            # 1️⃣ Checkout repository
            - name: Checkout repository
              uses: actions/checkout@v3

            # 2️⃣ Log in to GHCR
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            # 3️⃣ Build and push Docker image
            - name: Build and push Docker image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: true
                  tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

            # 4️⃣ Update Kubernetes deployment in k8s repo
            - name: Update deployment YAML in k8s repo
              env:
                  # K8S_REPO: https://github.com/niridoy/k8s.git
                  IMAGE_TAG: ${{ github.sha }}
                  GH_PAT: ${{ secrets.PAT_TOKEN }}
              run: |
                  # Clone k8s repo
                  git clone https://$GH_PAT@github.com/niridoy/k8s.git k8s-repo
                  cd k8s-repo

                  # Update deployment image
                  sed -i "s|image: ghcr.io/.*/sample-php-app:.*|image: ghcr.io/${{ github.repository }}:${IMAGE_TAG}|" deployment.yml

                  # Configure git
                  git config user.name "github-actions"
                  git config user.email "github-actions@github.com"

                  # Commit and push changes
                  git add deployment.yml
                  git commit -m "Update sample-php-app image to $IMAGE_TAG"
                  git push https://$GH_PAT@github.com/niridoy/k8s.git main
