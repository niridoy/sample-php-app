name: CI/CD Pipeline

on:
    pull_request:
        branches: [main]
        types: [opened, synchronize, reopened]
    push:
        branches: [main]

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    # 1️⃣ Build & Push Job - Builds Docker image and pushes to registry
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  push: true
                  tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    # 2️⃣ Deploy Job - Updates K8s Repo via PR
    deploy-k8s:
        needs: build-and-push
        if: github.event_name == 'push'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout k8s repository
              uses: actions/checkout@v3
              with:
                  repository: niridoy/k8s
                  token: ${{ secrets.PAT_TOKEN }}
                  path: k8s-repo

            - name: Create PR and Merge
              env:
                  GH_TOKEN: ${{ secrets.PAT_TOKEN }}
                  IMAGE_TAG: ${{ github.sha }}
              run: |
                  cd k8s-repo
                  
                  # Configure git
                  git config user.name "github-actions"
                  git config user.email "github-actions@github.com"
                  
                  # Create new branch
                  BRANCH="deploy-${IMAGE_TAG:0:7}"
                  git checkout -b $BRANCH

                  # Update deployment image
                  sed -i "s|image: ghcr.io/.*/sample-php-app:.*|image: ghcr.io/${{ github.repository }}:${IMAGE_TAG}|" sample-php/deployment.yml

                  # Commit and Push
                  git add sample-php/deployment.yml
                  git commit -m "Update image to $IMAGE_TAG"
                  git push origin $BRANCH

                  # Create PR and Merge
                  gh pr create --title "Deploy $IMAGE_TAG" --body "Updates image tag to $IMAGE_TAG" --base main --head $BRANCH
                  
                  # Attempt to merge (enable auto-merge if repo settings allow, or merge immediately)
                  gh pr merge $BRANCH --merge --auto || gh pr merge $BRANCH --merge
